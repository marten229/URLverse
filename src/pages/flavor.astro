---
import { getAllFlavors, getFlavorById } from "../lib/prompt-flavors";
import { FlavorService } from "../services/flavor-service";

export const prerender = false;

const flavors = getAllFlavors();

const currentFlavorId = FlavorService.getCurrentFlavorFromRequest(Astro.request);
const currentFlavor = getFlavorById(currentFlavorId);

// Handle flavor change
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const selectedFlavorId = formData.get("flavorId") as string;
    
    if (selectedFlavorId && FlavorService.isValidFlavor(selectedFlavorId)) {
      const cookieValue = FlavorService.saveFlavorToCookie(selectedFlavorId);
      
      return new Response(null, {
        status: 302,
        headers: {
          'Location': `/flavor?success=flavor-changed&flavor=${selectedFlavorId}`,
          'Set-Cookie': cookieValue
        }
      });
    }
  } catch (error) {
    console.error("Fehler beim √Ñndern des Flavors:", error);
  }
}

const url = new URL(Astro.request.url);
const success = url.searchParams.get("success");
const selectedFlavorFromUrl = url.searchParams.get("flavor");
---

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URLverse - Stil ausw√§hlen</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="/src/styles/main.css" />
</head>
<body class="admin">
  <div class="admin__container">
    <a href="/" class="admin__back-link">‚Üê Zur√ºck zur URLverse</a>
    
    <div class="admin__header">
      <h1 class="admin__title">üé® Stil ausw√§hlen</h1>
      <p class="admin__subtitle">W√§hle deinen bevorzugten Stil f√ºr generierte Seiten</p>
    </div>
    
    {success === "flavor-changed" && (
      <div class="admin__success">
        ‚úÖ Stil erfolgreich ge√§ndert zu: <strong>{getFlavorById(selectedFlavorFromUrl || currentFlavorId).name}</strong>
      </div>
    )}
    
    <div class="admin__current-flavor">
      <h2>üåü Aktuell ausgew√§hlt</h2>
      <div class="current-flavor-info">
        <strong>{currentFlavor.name}</strong>
        <span class="current-flavor-desc">{currentFlavor.description}</span>
      </div>
    </div>
    
    <div class="admin__flavors-grid">
      {flavors.map((flavor) => (
        <div class={`admin__flavor-card ${flavor.id === currentFlavor.id ? 'admin__flavor-card--current' : ''}`}>
          <div class="admin__flavor-header">
            <h3 class="admin__flavor-title">{flavor.name}</h3>
            {flavor.id === currentFlavor.id && (
              <span class="admin__flavor-badge">Aktiv</span>
            )}
          </div>
          
          <p class="admin__flavor-description">{flavor.description}</p>
          
          {flavor.examples && flavor.examples.length > 0 && (
            <div class="admin__flavor-examples">
              <h4>Beispiel-Inhalte:</h4>
              <ul>
                {flavor.examples.map((example) => (
                  <li>{example}</li>
                ))}
              </ul>
            </div>
          )}
          
          <form method="POST" class="admin__flavor-form">
            <input type="hidden" name="flavorId" value={flavor.id} />
            <button 
              type="submit" 
              class={`admin__select-button ${flavor.id === currentFlavor.id ? 'admin__select-button--active' : ''}`}
              disabled={flavor.id === currentFlavor.id}
            >
              {flavor.id === currentFlavor.id ? '‚úì Ausgew√§hlt' : 'Diesen Stil w√§hlen'}
            </button>
          </form>
        </div>
      ))}
    </div>
    
    <div class="admin__test-section">
      <h3 class="admin__test-title">üß™ Stil ausprobieren</h3>
      <p class="admin__test-description">Teste deinen gew√§hlten Stil mit diesen Beispiel-URLs:</p>
      <div class="admin__test-urls">
        <a href="/blog/ki-revolution-2024" class="admin__test-url">/blog/ki-revolution-2024</a>
        <a href="/shop/zeitreise-gadgets" class="admin__test-url">/shop/zeitreise-gadgets</a>
        <a href="/unternehmen/quantum-solutions" class="admin__test-url">/unternehmen/quantum-solutions</a>
        <a href="/medizin/nano-chirurgie" class="admin__test-url">/medizin/nano-chirurgie</a>
        <a href="/forum/diskussion/virtual-reality" class="admin__test-url">/forum/diskussion/virtual-reality</a>
      </div>
      
      <div class="admin__info-box">
        <h4>üí° Tipp:</h4>
        <p>Nachdem du einen Stil ausgew√§hlt hast, werden alle neu generierten Seiten in diesem Stil erstellt. Du kannst den Stil jederzeit hier √§ndern.</p>
      </div>
    </div>
  </div>
</body>
</html>