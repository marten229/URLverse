---
import Layout from "../components/Layout.astro";
import ApiKeyError from "../components/ApiKeyError.astro";
import GenerationError from "../components/GenerationError.astro";
import { PageGeneratorService } from "../services/page-generator";
import { FlavorService } from "../services/flavor-service";
import { parseSlugData } from "../utils/slug-parser";
import { config, validateApiKey } from "../lib/config";

export const prerender = false;

const slugData = parseSlugData(Astro.params, Astro.url);
const currentFlavorId = FlavorService.getCurrentFlavorFromRequest(
  Astro.request,
);

// API Key Validation
const apiKeyValidation = validateApiKey(Astro.request);

// Typ-Definition für das interne Result
// Typ-Definition für das interne Result
type PageLocalResult =
  | { component: true; error: string; content?: undefined; flavorId?: string }
  | { component?: false; content: string; error?: string; flavorId?: string };

let result: PageLocalResult;
let title = slugData.query || config.app.defaultTitle;

if (!apiKeyValidation.isValid) {
  // Zeige Fehlermeldung wenn kein API Key vorhanden
  // Nutze die Component für die Fehlermeldung
  result = {
    component: true,
    error: apiKeyValidation.error || "Unbekannter Fehler",
  };
  title = config.app.errorTitle;
} else {
  // Normale Seitengenerierung mit gültigem API Key
  const pageGenerator = new PageGeneratorService(
    apiKeyValidation.apiKey,
    Astro.request,
  );
  const genResult = await pageGenerator.generatePage(slugData, currentFlavorId);

  if (genResult.error === "INVALID_API_KEY") {
    result = {
      component: true,
      error: "Der verwendete API Key ist ungültig oder abgelaufen.",
      flavorId: currentFlavorId,
    };
    title = config.app.errorTitle;
  } else {
    result = {
      component: false,
      content: genResult.content,
      error: genResult.error,
      flavorId: currentFlavorId,
    };

    if (result.error) {
      title = config.app.errorTitle;
    }
  }
}

const content = result.content;
---

<Layout title={title} content={content}>
  {result.component && <ApiKeyError error={result.error} />}
  {
    !result.component && result.error && (
      <GenerationError error={result.error} flavorId={result.flavorId} />
    )
  }
</Layout>
